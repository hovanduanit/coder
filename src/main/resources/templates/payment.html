<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Thanh Toán</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        /* CSS đơn giản để tạo kiểu cho form */
        .container {
            max-width: 500px;
            margin: 50px auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        #card-element {
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        #submit, #retry-payment {
            background-color: #6772E5;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
        }
        #retry-payment {
            background-color: #28a745;
        }
        #payment-message {
            margin-top: 20px;
            display: none;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
<div class="container">
    <h2>Thanh Toán</h2>
    <form id="payment-form">
        <label for="email">Email:</label>
        <input type="email" id="email" name="email" required class="form-control" />

        <label for="amount">Số Tiền (USD):</label>
        <input type="number" id="amount" name="amount" required class="form-control" />

        <div id="card-element"><!-- Stripe.js sẽ tạo input thẻ ở đây --></div>
        <button id="submit">Thanh Toán</button>
        <div id="payment-message" class="hidden"></div>
    </form>

    <!-- Button để thanh toán lại với PaymentMethod đã lưu -->
    <button id="retry-payment">Thanh Toán Lại</button>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const stripe = Stripe('pk_test_51Q3Ggq2MBG1ftSLQa7LXnT1k8R7evJChz6qGfjxCZ8wKXqfYOvXI2qzoHnSjeGMT6dh4xhtnYy5sstvNBJLyKUMY00iROG7Hc9'); // Thay bằng Public Key của bạn
        const elements = stripe.elements();
        const cardElement = elements.create('card');
        cardElement.mount('#card-element');

        const form = document.getElementById('payment-form');
        const retryButton = document.getElementById('retry-payment');
        const paymentMessage = document.getElementById('payment-message');

        form.addEventListener('submit', async (event) => {
            event.preventDefault();

            // Lấy thông tin từ form
            const email = document.getElementById('email').value;
            const amount = parseInt(document.getElementById('amount').value) * 100; // Stripe tính bằng cents

            try {
                // Gửi yêu cầu tạo Payment Intent
                const response = await fetch('/payment/create-payment-intent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ amount: amount, email: email })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                const clientSecret = data.clientSecret;
                const customerId = data.customerId;

                if (!clientSecret) {
                    throw new Error('Không nhận được client secret từ server');
                }

                // Xác nhận thanh toán và lưu Payment Method
                const result = await stripe.confirmCardPayment(clientSecret, {
                    payment_method: {
                        card: cardElement,
                        billing_details: {
                            email: email,
                        },
                    },
                    setup_future_usage: 'off_session', // Để lưu Payment Method cho lần sau
                });

                if (result.error) {
                    // Thanh toán thất bại
                    paymentMessage.innerText = result.error.message;
                    paymentMessage.classList.remove('hidden');
                } else {
                    if (result.paymentIntent.status === 'succeeded') {
                        // Thanh toán thành công
                        window.location.href = "/payment/success";
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                paymentMessage.innerText = error.message;
                paymentMessage.classList.remove('hidden');
            }
        });

        // Sự kiện cho button thanh toán lại
        retryButton.addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const amount = parseInt(document.getElementById('amount').value) * 100; // Stripe tính bằng cents

            try {
                // Gửi yêu cầu tạo Payment Intent cho Customer đã lưu
                const response = await fetch('/payment/create-payment-intent-for-existing-customer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ amount: amount, email: email })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                const clientSecret = data.clientSecret;

                if (!clientSecret) {
                    throw new Error('Không nhận được client secret từ server');
                }

                // Xác nhận thanh toán với PaymentMethod đã lưu
                const result = await stripe.confirmCardPayment(clientSecret, {
                    payment_method: 'pm_saved_payment_method_id', // Thay bằng PaymentMethod ID thực tế đã lưu
                });

                if (result.error) {
                    // Thanh toán thất bại
                    paymentMessage.innerText = result.error.message;
                    paymentMessage.classList.remove('hidden');
                } else {
                    if (result.paymentIntent.status === 'succeeded') {
                        // Thanh toán thành công
                        window.location.href = "/payment/success";
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                paymentMessage.innerText = error.message;
                paymentMessage.classList.remove('hidden');
            }
        });
    });
</script>
</body>
</html>
